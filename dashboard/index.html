<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Controlling Dashboard</title>
    <meta name="description" content="InteraktivnÃ­ finanÄnÃ­ kontrolingovÃ½ dashboard â€“ OPEX, CAPEX, HR, Prodeje, Odchylky, KPI">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: rgba(17, 24, 39, 0.7);
            --border: rgba(75, 85, 99, 0.3);
            --border-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-primary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6, #a78bfa);
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-glow: 0 0 20px rgba(99,102,241,0.15);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        body::before {
            content:''; position:fixed; top:-50%; left:-50%; width:200%; height:200%;
            background:
                radial-gradient(ellipse at 20% 50%, rgba(99,102,241,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(139,92,246,0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(59,130,246,0.03) 0%, transparent 50%);
            z-index:-1; animation: ambientFloat 30s ease-in-out infinite;
        }
        @keyframes ambientFloat {
            0%,100%{transform:translate(0,0) rotate(0deg)} 33%{transform:translate(-2%,1%) rotate(1deg)} 66%{transform:translate(1%,-1%) rotate(-1deg)}
        }

        /* â”€â”€ HEADER â”€â”€ */
        .header { padding:20px 32px; border-bottom:1px solid var(--border); backdrop-filter:blur(20px); background:rgba(10,14,26,0.8); position:sticky; top:0; z-index:100; }
        .header-inner { max-width:1440px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; }
        .header h1 { font-size:20px; font-weight:700; background:var(--accent-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; letter-spacing:-0.02em; }
        .header-subtitle { font-size:12px; color:var(--text-muted); margin-top:2px; }
        .header-badge { display:inline-flex; align-items:center; gap:6px; padding:5px 12px; background:var(--success-bg); border:1px solid rgba(16,185,129,0.2); border-radius:20px; font-size:11px; font-weight:500; color:var(--success); }
        .header-badge::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--success); animation:pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* â”€â”€ FILTERS â”€â”€ */
        .filter-bar { max-width:1440px; margin:16px auto 0; padding:0 32px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .filter-bar label { font-size:11px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.06em; }
        .filter-bar select {
            padding:7px 12px; border-radius:var(--radius-sm); background:var(--bg-secondary);
            border:1px solid var(--border); color:var(--text-primary); font-size:12px;
            font-family:inherit; cursor:pointer; outline:none; min-width:140px;
            transition: border-color 0.2s;
        }
        .filter-bar select:hover { border-color:var(--border-glow); }
        .filter-bar select:focus { border-color:var(--accent-primary); box-shadow:var(--shadow-glow); }
        .filter-group { display:flex; flex-direction:column; gap:3px; }

        /* â”€â”€ TABS â”€â”€ */
        .tabs { max-width:1440px; margin:16px auto 0; padding:0 32px; display:flex; gap:4px; overflow-x:auto; }
        .tab { padding:9px 18px; border-radius:var(--radius-sm) var(--radius-sm) 0 0; background:transparent; border:1px solid transparent; border-bottom:none; color:var(--text-muted); font-size:13px; font-weight:500; cursor:pointer; transition:all 0.25s; white-space:nowrap; user-select:none; }
        .tab:hover { color:var(--text-secondary); background:rgba(99,102,241,0.05); }
        .tab.active { color:var(--text-primary); background:var(--bg-card); border-color:var(--border); box-shadow:var(--shadow-glow); }

        /* â”€â”€ CONTENT â”€â”€ */
        .content { max-width:1440px; margin:0 auto; padding:20px 32px 60px; }
        .tab-panel { display:none; animation:fadeIn 0.35s ease; }
        .tab-panel.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

        /* â”€â”€ CARDS â”€â”€ */
        .card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:22px; backdrop-filter:blur(12px); transition:all 0.3s; }
        .card:hover { border-color:var(--border-glow); box-shadow:var(--shadow-glow); }
        .card-title { font-size:13px; font-weight:600; color:var(--text-muted); margin-bottom:14px; text-transform:uppercase; letter-spacing:0.05em; }

        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:18px; }
        .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:18px; }
        .grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; }
        .grid-5 { display:grid; grid-template-columns:repeat(5,1fr); gap:14px; }
        .grid-6 { display:grid; grid-template-columns:repeat(6,1fr); gap:14px; }
        .mb-18 { margin-bottom:18px; }
        .mb-20 { margin-bottom:20px; }
        @media(max-width:1100px) { .grid-4,.grid-5,.grid-6{grid-template-columns:repeat(3,1fr)} .grid-3{grid-template-columns:1fr 1fr} }
        @media(max-width:700px) { .grid-2,.grid-3,.grid-4,.grid-5,.grid-6{grid-template-columns:1fr} .content{padding:14px} .tabs,.filter-bar{padding:0 14px} }

        /* â”€â”€ HERO CARDS â”€â”€ */
        .hero-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md); padding:18px; position:relative; overflow:hidden; transition:all 0.3s; }
        .hero-card:hover { transform:translateY(-2px); border-color:var(--border-glow); box-shadow:var(--shadow-glow); }
        .hero-card .label { font-size:10px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:6px; }
        .hero-card .value { font-size:22px; font-weight:800; letter-spacing:-0.02em; line-height:1.2; }
        .hero-card .sub { font-size:11px; color:var(--text-muted); margin-top:5px; display:flex; align-items:center; gap:4px; }
        .hero-card .sub .up { color:var(--success); }
        .hero-card .sub .down { color:var(--danger); }
        .hero-card .glow { position:absolute; top:0; right:0; width:70px; height:70px; border-radius:50%; filter:blur(35px); opacity:0.15; }
        .glow-indigo{background:#6366f1} .glow-green{background:#10b981} .glow-amber{background:#f59e0b} .glow-blue{background:#3b82f6} .glow-rose{background:#f43f5e} .glow-violet{background:#8b5cf6}

        /* â”€â”€ TABLE â”€â”€ */
        .data-table { width:100%; border-collapse:collapse; font-size:12px; }
        .data-table th { text-align:left; padding:8px 10px; border-bottom:1px solid var(--border); color:var(--text-muted); font-weight:600; font-size:10px; text-transform:uppercase; letter-spacing:.06em; }
        .data-table td { padding:8px 10px; border-bottom:1px solid rgba(75,85,99,0.15); color:var(--text-secondary); }
        .data-table tr:hover td { background:rgba(99,102,241,0.04); }
        .data-table .positive { color:var(--success); font-weight:600; }
        .data-table .negative { color:var(--danger); font-weight:600; }

        .chart-container { position:relative; width:100%; }
        .chart-container canvas { max-height:320px; }
        .section-header { font-size:17px; font-weight:700; margin-bottom:14px; letter-spacing:-0.01em; display:flex; align-items:center; gap:8px; }
        .section-header .icon { width:26px; height:26px; border-radius:var(--radius-sm); display:flex; align-items:center; justify-content:center; font-size:13px; }
    </style>
</head>
<body>
<header class="header">
    <div class="header-inner">
        <div>
            <h1>ğŸ“Š Financial Controlling Dashboard</h1>
            <div class="header-subtitle">Data z projektu â€¢ GenerovÃ¡no z CSV souborÅ¯</div>
        </div>
        <div class="header-badge">ReÃ¡lnÃ¡ data</div>
    </div>
</header>

<!-- FILTERS -->
<div class="filter-bar" id="filter-bar">
    <div class="filter-group">
        <label>Rok</label>
        <select id="filter-year"><option value="all">VÅ¡echny roky</option></select>
    </div>
    <div class="filter-group">
        <label>Region</label>
        <select id="filter-region"><option value="all">VÅ¡echny regiony</option></select>
    </div>
    <div class="filter-group">
        <label>StÅ™edisko</label>
        <select id="filter-cc"><option value="all">VÅ¡echna stÅ™ediska</option></select>
    </div>
    <div class="filter-group">
        <label>Kategorie produktu</label>
        <select id="filter-category"><option value="all">VÅ¡echny kategorie</option></select>
    </div>
</div>

<!-- TABS -->
<nav class="tabs" id="tabs">
    <div class="tab active" data-tab="kpis"><span class="tab-icon">ğŸ“ˆ</span> KPI</div>
    <div class="tab" data-tab="opex"><span class="tab-icon">ğŸ’°</span> OPEX</div>
    <div class="tab" data-tab="capex"><span class="tab-icon">ğŸ—ï¸</span> CAPEX</div>
    <div class="tab" data-tab="hr"><span class="tab-icon">ğŸ‘¥</span> HR Budget</div>
    <div class="tab" data-tab="sales"><span class="tab-icon">ğŸ›’</span> Prodeje</div>
    <div class="tab" data-tab="variance"><span class="tab-icon">ğŸ“Š</span> Odchylky</div>
</nav>

<main class="content">
    <!-- KPIs -->
    <section class="tab-panel active" id="panel-kpis">
        <div class="section-header"><span class="icon" style="background:rgba(99,102,241,0.15);color:#6366f1">ğŸ“ˆ</span>KlÃ­ÄovÃ© ukazatele vÃ½konnosti (KPI)</div>
        <div class="grid-6 mb-18" id="kpi-heroes"></div>
        <div class="grid-2 mb-18">
            <div class="card"><div class="card-title">TrÅ¾by & EBITDA (mÄ›sÃ­ÄnÄ›)</div><div class="chart-container"><canvas id="c-kpi-ebitda"></canvas></div></div>
            <div class="card"><div class="card-title">MarÅ¾e (%)</div><div class="chart-container"><canvas id="c-kpi-margins"></canvas></div></div>
        </div>
        <div class="grid-2">
            <div class="card"><div class="card-title">DSO & DPO (dny)</div><div class="chart-container"><canvas id="c-kpi-dso"></canvas></div></div>
            <div class="card"><div class="card-title">Cash Flow & Burn Rate</div><div class="chart-container"><canvas id="c-kpi-cf"></canvas></div></div>
        </div>
    </section>

    <!-- OPEX -->
    <section class="tab-panel" id="panel-opex">
        <div class="section-header"><span class="icon" style="background:rgba(245,158,11,0.15);color:#f59e0b">ğŸ’°</span>ProvoznÃ­ rozpoÄet (OPEX)</div>
        <div class="grid-4 mb-18" id="opex-heroes"></div>
        <div class="grid-2 mb-18">
            <div class="card"><div class="card-title">OPEX dle kategorie â€“ PlÃ¡n vs SkuteÄnost</div><div class="chart-container"><canvas id="c-opex-bar"></canvas></div></div>
            <div class="card"><div class="card-title">RozloÅ¾enÃ­ OPEX kategoriÃ­</div><div class="chart-container"><canvas id="c-opex-doughnut"></canvas></div></div>
        </div>
        <div class="card"><div class="card-title">MÄ›sÃ­ÄnÃ­ trend OPEX â€“ skuteÄnost</div><div class="chart-container"><canvas id="c-opex-monthly"></canvas></div></div>
    </section>

    <!-- CAPEX -->
    <section class="tab-panel" id="panel-capex">
        <div class="section-header"><span class="icon" style="background:rgba(59,130,246,0.15);color:#3b82f6">ğŸ—ï¸</span>InvestiÄnÃ­ rozpoÄet (CAPEX)</div>
        <div class="grid-3 mb-18" id="capex-heroes"></div>
        <div class="grid-2 mb-18">
            <div class="card"><div class="card-title">Investice vs Odpisy dle typu majetku</div><div class="chart-container"><canvas id="c-capex-bar"></canvas></div></div>
            <div class="card"><div class="card-title">MÄ›sÃ­ÄnÃ­ investice</div><div class="chart-container"><canvas id="c-capex-monthly"></canvas></div></div>
        </div>
    </section>

    <!-- HR -->
    <section class="tab-panel" id="panel-hr">
        <div class="section-header"><span class="icon" style="background:rgba(168,85,247,0.15);color:#a855f7">ğŸ‘¥</span>MzdovÃ½ plÃ¡n (HR Budget)</div>
        <div class="grid-4 mb-18" id="hr-heroes"></div>
        <div class="grid-2 mb-18">
            <div class="card"><div class="card-title">FTE & CelkovÃ© nÃ¡klady zamÄ›stnavatele</div><div class="chart-container"><canvas id="c-hr-fte"></canvas></div></div>
            <div class="card"><div class="card-title">PrÅ¯mÄ›rnÃ¡ hrubÃ¡ mzda & podÃ­l bonusÅ¯</div><div class="chart-container"><canvas id="c-hr-salary"></canvas></div></div>
        </div>
        <div class="card"><div class="card-title">Struktura ÃºvazkÅ¯</div><div class="chart-container"><canvas id="c-hr-contracts"></canvas></div></div>
    </section>

    <!-- SALES -->
    <section class="tab-panel" id="panel-sales">
        <div class="section-header"><span class="icon" style="background:rgba(16,185,129,0.15);color:#10b981">ğŸ›’</span>PÅ™edpovÄ›Ä prodejÅ¯ (Sales Forecast)</div>
        <div class="grid-4 mb-18" id="sales-heroes"></div>
        <div class="grid-2 mb-18">
            <div class="card"><div class="card-title">TrÅ¾by â€“ mÄ›sÃ­ÄnÃ­ trend</div><div class="chart-container"><canvas id="c-sales-trend"></canvas></div></div>
            <div class="card"><div class="card-title">TrÅ¾by dle kategorie produktu</div><div class="chart-container"><canvas id="c-sales-cat"></canvas></div></div>
        </div>
        <div class="grid-2">
            <div class="card"><div class="card-title">TrÅ¾by dle regionu</div><div class="chart-container"><canvas id="c-sales-region"></canvas></div></div>
            <div class="card"><div class="card-title">TrÅ¾by dle kanÃ¡lu</div><div class="chart-container"><canvas id="c-sales-channel"></canvas></div></div>
        </div>
    </section>

    <!-- VARIANCE -->
    <section class="tab-panel" id="panel-variance">
        <div class="section-header"><span class="icon" style="background:rgba(244,63,94,0.15);color:#f43f5e">ğŸ“Š</span>AnalÃ½za odchylek (Variance Analysis)</div>
        <div class="grid-4 mb-18" id="var-heroes"></div>
        <div class="grid-2 mb-18">
            <div class="card"><div class="card-title">Dekompozice odchylek dle kategorie</div><div class="chart-container"><canvas id="c-var-decomp"></canvas></div></div>
            <div class="card"><div class="card-title">MÄ›sÃ­ÄnÃ­ plÃ¡n vs skuteÄnost</div><div class="chart-container"><canvas id="c-var-monthly"></canvas></div></div>
        </div>
        <div class="card"><div class="card-title">Detail odchylek</div><div style="overflow-x:auto"><table class="data-table" id="var-table"></table></div></div>
    </section>
</main>

<script src="data.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const D = FINANCIAL_DATA;
const CZK = new Intl.NumberFormat('cs-CZ', { style:'currency', currency:'CZK', minimumFractionDigits:0, maximumFractionDigits:0 });
const CZKshort = (n) => {
    const abs = Math.abs(n);
    const sign = n < 0 ? 'âˆ’' : '';
    if (abs >= 1e9) return sign + (abs/1e9).toFixed(1).replace('.',',') + ' mld. KÄ';
    if (abs >= 1e6) return sign + (abs/1e6).toFixed(1).replace('.',',') + ' mil. KÄ';
    if (abs >= 1e3) return sign + (abs/1e3).toFixed(0) + ' tis. KÄ';
    return CZK.format(n);
};
const pct = n => n.toFixed(1).replace('.',',') + ' %';
const fmtPeriod = p => { const [y,m] = p.split('-'); const mNames=['Led','Ãšno','BÅ™e','Dub','KvÄ›','ÄŒvn','ÄŒvc','Srp','ZÃ¡Å™','Å˜Ã­j','Lis','Pro']; return mNames[parseInt(m)-1]+' '+y; };
const fmtPeriodShort = p => { const [y,m] = p.split('-'); const mNames=['Led','Ãšno','BÅ™e','Dub','KvÄ›','ÄŒvn','ÄŒvc','Srp','ZÃ¡Å™','Å˜Ã­j','Lis','Pro']; return mNames[parseInt(m)-1]+" '"+y.slice(2); };

function heroCard(label, value, sub, glowClass='glow-indigo') {
    return `<div class="hero-card"><div class="glow ${glowClass}"></div><div class="label">${label}</div><div class="value">${value}</div><div class="sub">${sub}</div></div>`;
}

const COLORS = { indigo:'#6366f1', violet:'#8b5cf6', blue:'#3b82f6', green:'#10b981', amber:'#f59e0b', rose:'#f43f5e', cyan:'#06b6d4', pink:'#ec4899', teal:'#14b8a6', orange:'#f97316' };
const COLOR_ARR = Object.values(COLORS);
const alphaC = (hex,a) => { const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; };
const baseOpts = () => ({
    responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{labels:{color:'#9ca3af',font:{size:11,family:'Inter'},padding:14,usePointStyle:true,pointStyleWidth:8}}, tooltip:{backgroundColor:'rgba(17,24,39,0.95)',titleColor:'#f9fafb',bodyColor:'#d1d5db',borderColor:'rgba(75,85,99,0.3)',borderWidth:1,padding:10,cornerRadius:8,titleFont:{weight:'600',family:'Inter'},bodyFont:{family:'Inter'},callbacks:{label:ctx=>{const v=ctx.parsed.y??ctx.parsed; return ctx.dataset.label+': '+CZK.format(Math.round(v))}}} },
    scales:{ x:{ticks:{color:'#6b7280',font:{size:10,family:'Inter'}},grid:{color:'rgba(75,85,99,0.12)'}}, y:{ticks:{color:'#6b7280',font:{size:10,family:'Inter'},callback:v=>CZKshort(v)},grid:{color:'rgba(75,85,99,0.12)'}} }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const elYear = document.getElementById('filter-year');
const elRegion = document.getElementById('filter-region');
const elCC = document.getElementById('filter-cc');
const elCat = document.getElementById('filter-category');

D.filters.years.forEach(y => { const o=document.createElement('option'); o.value=y; o.textContent=y; elYear.appendChild(o); });
D.filters.regions.forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; elRegion.appendChild(o); });
D.filters.cost_centers.forEach(c => { const o=document.createElement('option'); o.value=c.id; o.textContent=c.id+' â€“ '+c.name; elCC.appendChild(o); });
D.filters.categories.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; elCat.appendChild(o); });

function getFilters() {
    return { year: elYear.value, region: elRegion.value, cc: elCC.value, category: elCat.value };
}
function matchYear(period, y) { return y==='all' || period.startsWith(y); }
function matchRegion(row, r) { return r==='all' || row.region === r; }
function matchCC(row, c) { return c==='all' || row.cost_center_id === c; }
function matchCat(row, c) { return c==='all' || row.product_category === c; }

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-'+tab.dataset.tab).classList.add('active');
    });
});

// Chart registry for destruction
const charts = {};
function makeChart(id, cfg) {
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(document.getElementById(id), cfg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
    const f = getFilters();
    renderKPIs(f);
    renderOPEX(f);
    renderCAPEX(f);
    renderHR(f);
    renderSales(f);
    renderVariance(f);
}

// â”€â”€ 1. KPIs â”€â”€
function renderKPIs(f) {
    const data = D.kpis.filter(r => matchYear(r.period, f.year));
    if (!data.length) { document.getElementById('kpi-heroes').innerHTML='<p style="color:var(--text-muted)">Å½Ã¡dnÃ¡ data pro zvolenÃ½ filtr</p>'; return; }

    const totalRev = data.reduce((s,r)=>s+r.revenue,0);
    const totalEbitda = data.reduce((s,r)=>s+r.ebitda,0);
    const avgGM = data.reduce((s,r)=>s+r.gross_margin_pct,0)/data.length;
    const avgEM = data.reduce((s,r)=>s+r.ebitda_margin_pct,0)/data.length;
    const avgDSO = data.reduce((s,r)=>s+r.dso_days,0)/data.length;
    const avgDPO = data.reduce((s,r)=>s+r.dpo_days,0)/data.length;

    document.getElementById('kpi-heroes').innerHTML = [
        heroCard('CelkovÃ© trÅ¾by', CZKshort(totalRev), f.year==='all'?'CelÃ© obdobÃ­':'Rok '+f.year, 'glow-green'),
        heroCard('EBITDA', CZKshort(totalEbitda), 'ProvoznÃ­ zisk pÅ™ed odpisy', 'glow-indigo'),
        heroCard('EBITDA marÅ¾e', pct(avgEM), 'PrÅ¯mÄ›r za obdobÃ­', 'glow-violet'),
        heroCard('HrubÃ¡ marÅ¾e', pct(avgGM), 'TrÅ¾by âˆ’ COGS / TrÅ¾by', 'glow-blue'),
        heroCard('PrÅ¯mÄ›r DSO', Math.round(avgDSO)+' dnÃ­', 'Doba splatnosti pohledÃ¡vek', 'glow-amber'),
        heroCard('PrÅ¯mÄ›r DPO', Math.round(avgDPO)+' dnÃ­', 'Doba splatnosti zÃ¡vazkÅ¯', 'glow-rose'),
    ].join('');

    const labels = data.map(r=>fmtPeriodShort(r.period));
    makeChart('c-kpi-ebitda', { type:'bar', data:{ labels, datasets:[
        {label:'TrÅ¾by',data:data.map(r=>r.revenue),backgroundColor:alphaC(COLORS.indigo,0.5),borderColor:COLORS.indigo,borderWidth:1,borderRadius:3,order:2},
        {label:'EBITDA',data:data.map(r=>r.ebitda),type:'line',borderColor:COLORS.green,backgroundColor:alphaC(COLORS.green,0.1),pointRadius:2,tension:0.3,fill:true,order:1}
    ]}, options:baseOpts()});

    makeChart('c-kpi-margins', {type:'line',data:{labels,datasets:[
        {label:'EBITDA marÅ¾e %',data:data.map(r=>r.ebitda_margin_pct),borderColor:COLORS.indigo,tension:0.3},
        {label:'HrubÃ¡ marÅ¾e %',data:data.map(r=>r.gross_margin_pct),borderColor:COLORS.green,tension:0.3},
        {label:'ROA %',data:data.map(r=>r.roa_pct),borderColor:COLORS.amber,tension:0.3},
    ]},options:{...baseOpts(),scales:{...baseOpts().scales,y:{ticks:{color:'#6b7280',font:{size:10},callback:v=>v+'%'},grid:{color:'rgba(75,85,99,0.12)'}}}}});

    makeChart('c-kpi-dso', {type:'line',data:{labels,datasets:[
        {label:'DSO (dny)',data:data.map(r=>r.dso_days),borderColor:COLORS.blue,backgroundColor:alphaC(COLORS.blue,0.1),tension:0.3,fill:true},
        {label:'DPO (dny)',data:data.map(r=>r.dpo_days),borderColor:COLORS.amber,backgroundColor:alphaC(COLORS.amber,0.1),tension:0.3,fill:true},
    ]},options:{...baseOpts(),scales:{...baseOpts().scales,y:{ticks:{color:'#6b7280',font:{size:10},callback:v=>v+' dnÃ­'},grid:{color:'rgba(75,85,99,0.12)'}}}}});

    makeChart('c-kpi-cf', {type:'bar',data:{labels,datasets:[
        {label:'Burn Rate',data:data.map(r=>r.burn_rate),backgroundColor:alphaC(COLORS.rose,0.4),borderRadius:3},
        {label:'ÄŒistÃ½ Cash Flow',data:data.map(r=>r.net_cashflow),type:'line',borderColor:COLORS.green,pointRadius:2,tension:0.3}
    ]},options:baseOpts()});
}

// â”€â”€ 2. OPEX â”€â”€
function renderOPEX(f) {
    const rows = D.opex.filter(r => matchYear(r.period,f.year) && matchRegion(r,f.region) && matchCC(r,f.cc));
    // Aggregate by category
    const byCat = {};
    const byPeriodCat = {};
    rows.forEach(r => {
        if (!byCat[r.category]) byCat[r.category] = {planned:0, actual:0};
        byCat[r.category].planned += r.planned;
        byCat[r.category].actual += r.actual;
        const pk = r.period+'|'+r.category;
        if (!byPeriodCat[r.period]) byPeriodCat[r.period] = {};
        if (!byPeriodCat[r.period][r.category]) byPeriodCat[r.period][r.category] = 0;
        byPeriodCat[r.period][r.category] += r.actual;
    });

    const cats = Object.keys(byCat).sort();
    const totalPlan = Object.values(byCat).reduce((s,c)=>s+c.planned,0);
    const totalAct = Object.values(byCat).reduce((s,c)=>s+c.actual,0);
    const totalVar = totalAct - totalPlan;
    const biggest = cats.reduce((a,c)=>byCat[c].actual>byCat[a].actual?c:a, cats[0]||'');

    document.getElementById('opex-heroes').innerHTML = [
        heroCard('PlÃ¡n OPEX celkem', CZKshort(totalPlan), 'RoÄnÃ­ rozpoÄet', 'glow-amber'),
        heroCard('SkuteÄnost OPEX', CZKshort(totalAct), `${totalVar>=0?'â–²':'â–¼'} ${pct(totalPlan?totalVar/totalPlan*100:0)} vs plÃ¡n`, 'glow-indigo'),
        heroCard('NejvÄ›tÅ¡Ã­ kategorie', biggest, CZKshort(byCat[biggest]?.actual||0), 'glow-violet'),
        heroCard('CelkovÃ¡ odchylka', CZKshort(totalVar), totalVar>0?'<span class="down">PÅ™eÄerpÃ¡no</span>':'<span class="up">Ãšspora</span>', 'glow-rose'),
    ].join('');

    makeChart('c-opex-bar', {type:'bar', data:{labels:cats, datasets:[
        {label:'PlÃ¡n',data:cats.map(c=>byCat[c].planned),backgroundColor:alphaC(COLORS.blue,0.45),borderRadius:3},
        {label:'SkuteÄnost',data:cats.map(c=>byCat[c].actual),backgroundColor:alphaC(COLORS.indigo,0.65),borderRadius:3}
    ]}, options:{...baseOpts(),indexAxis:'y'}});

    makeChart('c-opex-doughnut', {type:'doughnut', data:{labels:cats, datasets:[{data:cats.map(c=>byCat[c].actual),backgroundColor:COLOR_ARR.slice(0,cats.length),borderWidth:0}]},
        options:{responsive:true,maintainAspectRatio:false,cutout:'62%',plugins:{legend:{labels:{color:'#9ca3af',font:{size:11,family:'Inter'},padding:10,usePointStyle:true}},tooltip:{callbacks:{label:ctx=>ctx.label+': '+CZK.format(Math.round(ctx.parsed))}}}}});

    const periods = Object.keys(byPeriodCat).sort();
    const topCats = cats.slice(0,4);
    makeChart('c-opex-monthly', {type:'line', data:{labels:periods.map(fmtPeriodShort), datasets:topCats.map((c,i)=>({
        label:c, data:periods.map(p=>(byPeriodCat[p]||{})[c]||0), borderColor:COLOR_ARR[i], tension:0.3
    }))}, options:baseOpts()});
}

// â”€â”€ 3. CAPEX â”€â”€
function renderCAPEX(f) {
    const rows = D.capex.filter(r => matchYear(r.period,f.year) && matchRegion(r,f.region) && matchCC(r,f.cc));
    const byCat = {};
    const byPeriod = {};
    rows.forEach(r => {
        const cat = r.asset_category;
        if (!byCat[cat]) byCat[cat]={investment:0,depreciation:0};
        byCat[cat].investment += r.investment;
        byCat[cat].depreciation += r.depreciation;
        if (!byPeriod[r.period]) byPeriod[r.period]={inv:0,depr:0};
        byPeriod[r.period].inv += r.investment;
        byPeriod[r.period].depr += r.depreciation;
    });

    const cats = Object.keys(byCat).filter(c=>c!=='Odpisy'&&c!=='OprÃ¡vky').sort();
    const totalInv = cats.reduce((s,c)=>s+byCat[c].investment,0);
    const totalDepr = (byCat['Odpisy']||{depreciation:0}).depreciation;

    document.getElementById('capex-heroes').innerHTML = [
        heroCard('CelkovÃ© investice', CZKshort(totalInv), 'Do dlouhodobÃ©ho majetku', 'glow-blue'),
        heroCard('CelkovÃ© odpisy', CZKshort(totalDepr), 'NÃ¡klady na odpisy', 'glow-amber'),
        heroCard('ÄŒistÃ¡ hodnota', CZKshort(totalInv-totalDepr), 'Investice âˆ’ odpisy', 'glow-green'),
    ].join('');

    makeChart('c-capex-bar', {type:'bar', data:{labels:cats, datasets:[
        {label:'Investice',data:cats.map(c=>byCat[c].investment),backgroundColor:alphaC(COLORS.blue,0.55),borderRadius:3},
        {label:'Odpisy',data:cats.map(c=>byCat[c].depreciation),backgroundColor:alphaC(COLORS.amber,0.55),borderRadius:3},
    ]}, options:baseOpts()});

    const periods = Object.keys(byPeriod).sort();
    makeChart('c-capex-monthly', {type:'bar', data:{labels:periods.map(fmtPeriodShort), datasets:[
        {label:'Investice',data:periods.map(p=>byPeriod[p].inv),backgroundColor:alphaC(COLORS.blue,0.5),borderRadius:2},
        {label:'Odpisy',data:periods.map(p=>byPeriod[p].depr),type:'line',borderColor:COLORS.amber,tension:0.3,pointRadius:2}
    ]}, options:baseOpts()});
}

// â”€â”€ 4. HR â”€â”€
function renderHR(f) {
    const rows = D.hr.filter(r => matchYear(r.period,f.year) && matchRegion(r,f.region) && matchCC(r,f.cc));
    // Aggregate by period
    const byPeriod = {};
    let totalFT=0, totalPT=0, totalDPP=0;
    rows.forEach(r => {
        if (!byPeriod[r.period]) byPeriod[r.period]={hc:0,fte:0,cost:0,gross:0,bonuses:0,count:0};
        byPeriod[r.period].hc += r.headcount;
        byPeriod[r.period].fte += r.effective_fte;
        byPeriod[r.period].cost += r.employer_cost;
        byPeriod[r.period].gross += r.gross_total;
        byPeriod[r.period].bonuses += r.bonuses;
        byPeriod[r.period].count++;
        totalFT+=r.fte_full_time; totalPT+=r.fte_part_time; totalDPP+=r.fte_contractors;
    });

    const periods = Object.keys(byPeriod).sort();
    const lastP = periods[periods.length-1];
    const last = byPeriod[lastP] || {hc:0,fte:0,cost:0};
    const totalCost = Object.values(byPeriod).reduce((s,p)=>s+p.cost,0);

    document.getElementById('hr-heroes').innerHTML = [
        heroCard('PoÄet zamÄ›stnancÅ¯', last.hc.toString(), lastP?fmtPeriod(lastP):'', 'glow-violet'),
        heroCard('EfektivnÃ­ FTE', last.fte.toFixed(1), 'PÅ™epoÄtenÃ½ Ãºvazek', 'glow-indigo'),
        heroCard('CelkovÃ© nÃ¡klady', CZKshort(totalCost), 'Za zvolenÃ© obdobÃ­', 'glow-green'),
        heroCard('PrÅ¯m. hrubÃ¡ mzda', last.hc? CZKshort(last.gross/last.hc) : '0 KÄ', 'PoslednÃ­ mÄ›sÃ­c', 'glow-amber'),
    ].join('');

    makeChart('c-hr-fte', {type:'bar', data:{labels:periods.map(fmtPeriodShort), datasets:[
        {label:'NÃ¡klady zamÄ›stnavatele',data:periods.map(p=>byPeriod[p].cost),backgroundColor:alphaC(COLORS.indigo,0.5),borderRadius:2,yAxisID:'y'},
        {label:'EfektivnÃ­ FTE',data:periods.map(p=>byPeriod[p].fte),type:'line',borderColor:COLORS.green,tension:0.3,pointRadius:2,yAxisID:'y1'}
    ]}, options:{...baseOpts(),scales:{y:{position:'left',ticks:{color:'#6b7280',font:{size:10},callback:v=>CZKshort(v)},grid:{color:'rgba(75,85,99,0.12)'}},y1:{position:'right',ticks:{color:'#10b981',font:{size:10}},grid:{drawOnChartArea:false}},x:{ticks:{color:'#6b7280',font:{size:10}},grid:{color:'rgba(75,85,99,0.12)'}}}}});

    makeChart('c-hr-salary', {type:'line', data:{labels:periods.map(fmtPeriodShort), datasets:[
        {label:'PrÅ¯m. hrubÃ¡ mzda',data:periods.map(p=>byPeriod[p].hc?byPeriod[p].gross/byPeriod[p].hc:0),borderColor:COLORS.indigo,tension:0.3,yAxisID:'y'},
        {label:'PodÃ­l bonusÅ¯ (%)',data:periods.map(p=>byPeriod[p].gross?byPeriod[p].bonuses/byPeriod[p].gross*100:0),borderColor:COLORS.amber,tension:0.3,yAxisID:'y1'}
    ]}, options:{...baseOpts(),scales:{y:{position:'left',ticks:{color:'#6b7280',font:{size:10},callback:v=>CZKshort(v)},grid:{color:'rgba(75,85,99,0.12)'}},y1:{position:'right',ticks:{color:'#f59e0b',font:{size:10},callback:v=>v.toFixed(0)+'%'},grid:{drawOnChartArea:false}},x:{ticks:{color:'#6b7280',font:{size:10}},grid:{color:'rgba(75,85,99,0.12)'}}}}});

    const nPeriods = periods.length || 1;
    makeChart('c-hr-contracts', {type:'doughnut', data:{labels:['PlnÃ½ Ãºvazek','ÄŒÃ¡steÄnÃ½ Ãºvazek','DPP'], datasets:[{data:[totalFT/nPeriods,totalPT/nPeriods,totalDPP/nPeriods].map(Math.round),backgroundColor:[COLORS.indigo,COLORS.amber,COLORS.rose],borderWidth:0}]},
        options:{responsive:true,maintainAspectRatio:false,cutout:'62%',plugins:{legend:{labels:{color:'#9ca3af',font:{size:11,family:'Inter'},padding:10,usePointStyle:true}}}}});
}

// â”€â”€ 5. SALES â”€â”€
function renderSales(f) {
    const rows = D.sales.filter(r => matchYear(r.period,f.year) && matchRegion(r,f.region) && matchCat(r,f.category));
    const byPeriod = {};
    const byCat = {};
    const byRegion = {};
    const byChannel = {};
    let totalQty=0, totalRev=0, totalCogs=0;

    rows.forEach(r => {
        if (!byPeriod[r.period]) byPeriod[r.period]={rev:0,qty:0,cogs:0};
        byPeriod[r.period].rev += r.revenue;
        byPeriod[r.period].qty += r.quantity;
        byPeriod[r.period].cogs += r.cogs;
        byCat[r.product_category] = (byCat[r.product_category]||0) + r.revenue;
        byRegion[r.region] = (byRegion[r.region]||0) + r.revenue;
        byChannel[r.channel] = (byChannel[r.channel]||0) + r.revenue;
        totalQty+=r.quantity; totalRev+=r.revenue; totalCogs+=r.cogs;
    });

    const gm = totalRev ? (totalRev-totalCogs)/totalRev*100 : 0;
    document.getElementById('sales-heroes').innerHTML = [
        heroCard('CelkovÃ© trÅ¾by', CZKshort(totalRev), f.year==='all'?'CelÃ© obdobÃ­':'Rok '+f.year, 'glow-green'),
        heroCard('ProdanÃ© kusy', totalQty.toLocaleString('cs-CZ'), 'CelkovÃ½ objem', 'glow-blue'),
        heroCard('HrubÃ¡ marÅ¾e', pct(gm), 'TrÅ¾by âˆ’ COGS / TrÅ¾by', 'glow-violet'),
        heroCard('PrÅ¯m. cena', totalQty?CZKshort(totalRev/totalQty):'0 KÄ', 'Na jednotku', 'glow-amber'),
    ].join('');

    const periods = Object.keys(byPeriod).sort();
    makeChart('c-sales-trend', {type:'line', data:{labels:periods.map(fmtPeriodShort), datasets:[
        {label:'TrÅ¾by',data:periods.map(p=>byPeriod[p].rev),borderColor:COLORS.green,backgroundColor:alphaC(COLORS.green,0.1),tension:0.3,fill:true,pointRadius:2},
    ]}, options:baseOpts()});

    const catKeys = Object.entries(byCat).sort((a,b)=>b[1]-a[1]).map(e=>e[0]);
    makeChart('c-sales-cat', {type:'bar', data:{labels:catKeys, datasets:[{label:'TrÅ¾by',data:catKeys.map(c=>byCat[c]),backgroundColor:COLOR_ARR.slice(0,catKeys.length),borderRadius:3}]},
        options:{...baseOpts(),indexAxis:'y',plugins:{...baseOpts().plugins,legend:{display:false}}}});

    const regKeys = Object.entries(byRegion).sort((a,b)=>b[1]-a[1]).map(e=>e[0]);
    makeChart('c-sales-region', {type:'bar', data:{labels:regKeys, datasets:[{label:'TrÅ¾by',data:regKeys.map(r=>byRegion[r]),backgroundColor:alphaC(COLORS.indigo,0.55),borderRadius:3}]},
        options:{...baseOpts(),plugins:{...baseOpts().plugins,legend:{display:false}}}});

    const chKeys = Object.entries(byChannel).sort((a,b)=>b[1]-a[1]).map(e=>e[0]);
    makeChart('c-sales-channel', {type:'doughnut', data:{labels:chKeys, datasets:[{data:chKeys.map(c=>byChannel[c]),backgroundColor:COLOR_ARR.slice(0,chKeys.length),borderWidth:0}]},
        options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{labels:{color:'#9ca3af',font:{size:11,family:'Inter'},padding:10,usePointStyle:true}},tooltip:{callbacks:{label:ctx=>ctx.label+': '+CZK.format(Math.round(ctx.parsed))}}}}});
}

// â”€â”€ 6. VARIANCE â”€â”€
function renderVariance(f) {
    const rows = D.variance.filter(r => matchYear(r.period,f.year) && matchCat(r,f.category));
    const byCat = {};
    const byPeriod = {};
    rows.forEach(r => {
        if (!byCat[r.product_category]) byCat[r.product_category]={vol:0,price:0,cost:0,total:0};
        byCat[r.product_category].vol += r.volume_variance;
        byCat[r.product_category].price += r.price_variance;
        byCat[r.product_category].cost += r.cost_variance;
        byCat[r.product_category].total += r.total_variance;
        if (!byPeriod[r.period]) byPeriod[r.period]={plan:0,actual:0};
        byPeriod[r.period].plan += r.plan_revenue;
        byPeriod[r.period].actual += r.actual_revenue;
    });

    const totalVol = Object.values(byCat).reduce((s,c)=>s+c.vol,0);
    const totalPrice = Object.values(byCat).reduce((s,c)=>s+c.price,0);
    const totalCost = Object.values(byCat).reduce((s,c)=>s+c.cost,0);
    const totalTotal = Object.values(byCat).reduce((s,c)=>s+c.total,0);
    const favUnfav = v => v>=0 ? '<span class="up">PÅ™Ã­znivÃ©</span>' : '<span class="down">NepÅ™Ã­znivÃ©</span>';

    document.getElementById('var-heroes').innerHTML = [
        heroCard('ObjemovÃ¡ odchylka', CZKshort(totalVol), favUnfav(totalVol), 'glow-green'),
        heroCard('CenovÃ¡ odchylka', CZKshort(totalPrice), favUnfav(totalPrice), 'glow-indigo'),
        heroCard('NÃ¡kladovÃ¡ odchylka', CZKshort(totalCost), favUnfav(-totalCost), 'glow-rose'),
        heroCard('CelkovÃ¡ odchylka', CZKshort(totalTotal), favUnfav(totalTotal), 'glow-violet'),
    ].join('');

    const cats = Object.keys(byCat).sort();
    makeChart('c-var-decomp', {type:'bar', data:{labels:cats, datasets:[
        {label:'ObjemovÃ¡',data:cats.map(c=>byCat[c].vol),backgroundColor:alphaC(COLORS.green,0.6),borderRadius:2},
        {label:'CenovÃ¡',data:cats.map(c=>byCat[c].price),backgroundColor:alphaC(COLORS.indigo,0.6),borderRadius:2},
        {label:'NÃ¡kladovÃ¡',data:cats.map(c=>byCat[c].cost),backgroundColor:alphaC(COLORS.rose,0.6),borderRadius:2},
    ]}, options:{...baseOpts(),scales:{x:{stacked:true,ticks:{color:'#6b7280',font:{size:10}},grid:{color:'rgba(75,85,99,0.12)'}},y:{stacked:true,ticks:{color:'#6b7280',font:{size:10},callback:v=>CZKshort(v)},grid:{color:'rgba(75,85,99,0.12)'}}}}});

    const periods = Object.keys(byPeriod).sort();
    makeChart('c-var-monthly', {type:'line', data:{labels:periods.map(fmtPeriodShort), datasets:[
        {label:'SkuteÄnost',data:periods.map(p=>byPeriod[p].actual),borderColor:COLORS.green,backgroundColor:alphaC(COLORS.green,0.1),tension:0.3,fill:true,pointRadius:2},
        {label:'PlÃ¡n (pÅ™edchozÃ­ rok)',data:periods.map(p=>byPeriod[p].plan),borderColor:COLORS.blue,borderDash:[5,3],tension:0.3,pointRadius:2}
    ]}, options:baseOpts()});

    // Table
    let html='<thead><tr><th>Kategorie</th><th>ObjemovÃ¡</th><th>CenovÃ¡</th><th>NÃ¡kladovÃ¡</th><th>CelkovÃ¡</th></tr></thead><tbody>';
    cats.forEach(c => {
        const cls = n => n>=0?'positive':'negative';
        html+=`<tr><td style="color:var(--text-primary);font-weight:500">${c}</td>
            <td class="${cls(byCat[c].vol)}">${CZKshort(byCat[c].vol)}</td>
            <td class="${cls(byCat[c].price)}">${CZKshort(byCat[c].price)}</td>
            <td class="${cls(-byCat[c].cost)}">${CZKshort(byCat[c].cost)}</td>
            <td class="${cls(byCat[c].total)}" style="font-weight:700">${CZKshort(byCat[c].total)}</td></tr>`;
    });
    html+='</tbody>';
    document.getElementById('var-table').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT + FILTER EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderAll();
[elYear, elRegion, elCC, elCat].forEach(el => el.addEventListener('change', renderAll));
</script>
</body>
</html>
